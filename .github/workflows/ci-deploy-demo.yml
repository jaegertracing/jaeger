name: Deploy Jaeger Demo to OKE

on:
  schedule:
    - cron: '0 13 * * *'  # Daily at 8:00 AM US Eastern Time (ET)
  workflow_dispatch:

permissions: read-all

jobs:
  deploy:
    name: Deploy Jaeger to OKE Cluster
    runs-on: ubuntu-latest
    env:
      OCI_CLI_USER: ${{ secrets.OCI_CLI_USER }}
      OCI_CLI_TENANCY: ${{ secrets.OCI_CLI_TENANCY }}
      OCI_CLI_FINGERPRINT: ${{ secrets.OCI_CLI_FINGERPRINT }}
      OCI_CLI_KEY_CONTENT: ${{ secrets.OCI_CLI_KEY_CONTENT }}
      OCI_CLI_REGION: ${{ secrets.OCI_CLI_REGION }}

    steps:
    - name: Configure kubectl with OKE
      uses: oracle-actions/configure-kubectl-oke@77a733d79446dabe7bf0e58eb56197d33ce4dc58 # v1.5.0
      with:
        cluster: ${{ secrets.OKE_CLUSTER_OCID }}
        enablePrivateEndpoint: false
    
    - name: Install Helm
      uses: azure/setup-helm@b9e51907a09c216f16ebe8536097933489208112 # v4
        
    - name: Checkout jaeger repository
      uses: actions/checkout@1af3b93b6815bc44a9784bd300feb67ff0d1eeb3 # v6

    - name: Deploy using appropriate script
      run: |
        if [ "${{ github.event_name }}" = "schedule" ]; then
          echo "ðŸ•’ Scheduled run - using deploy-all.sh (upgrade mode)"
          bash ./examples/oci/deploy-all.sh
        else
          echo "ðŸ”„ Manual run - using deploy-all.sh with clean mode (uninstall/install)"
          bash ./examples/oci/deploy-all.sh clean
        fi         

    - name: Send detailed Slack notification on failure
      if: failure()
      uses: rtCamp/action-slack-notify@4e5fb42d249be6a45a298f3c9543b111b02f7907 # v2.3.0
      env:
        SLACK_WEBHOOK: ${{ secrets.SLACK_WEBHOOK_URL }}
        SLACK_CHANNEL: '#jaeger-operations'
        SLACK_COLOR: danger
        SLACK_USERNAME: 'Jaeger CI Bot'
        SLACK_ICON_EMOJI: ':warning:'
        SLACK_TITLE: 'ðŸš¨ Jaeger OKE Deployment Failed'
        SLACK_MESSAGE: |
          *Repository:* ${{ github.repository }}
          *Workflow:* ${{ github.workflow }}
          *Run ID:* ${{ github.run_id }}
          *Trigger:* ${{ github.event_name }}
          *Actor:* ${{ github.actor }}
          
          <${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}|ðŸ”— View Failed Run>
        SLACK_FOOTER: 'Jaeger CI/CD Pipeline'
        
