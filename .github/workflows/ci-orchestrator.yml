name: CI Orchestrator

on:
  pull_request:
    branches: [main]
  push:
    branches: [main]
  merge_group:

concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true

# See https://github.com/ossf/scorecard/blob/main/docs/checks.md#token-permissions
permissions:
  contents: read

jobs:
  # ============================================================================
  # TIER 1: Cheap Checks (Linters, Static Analysis)
  # ============================================================================
  lint-checks:
    uses: ./.github/workflows/ci-lint-checks.yaml
    secrets: inherit

  codeql:
    uses: ./.github/workflows/codeql.yml
    secrets: inherit

  dependency-review:
    uses: ./.github/workflows/dependency-review.yml
    secrets: inherit

  fossa:
    uses: ./.github/workflows/fossa.yml
    secrets: inherit

  # ============================================================================
  # TIER 2: Unit Tests (Depends on Tier 1)
  # ============================================================================
  unit-tests:
    needs: [lint-checks, codeql, dependency-review, fossa]
    uses: ./.github/workflows/ci-unit-tests.yml
    secrets: inherit

  # ============================================================================
  # TIER 3: Expensive Checks (E2E, Builds, Docker) - Depends on Tier 2
  # ============================================================================
  
  # Binary builds
  build-binaries:
    needs: [unit-tests]
    uses: ./.github/workflows/ci-build-binaries.yml
    secrets: inherit

  # Docker images
  docker-build:
    needs: [unit-tests]
    uses: ./.github/workflows/ci-docker-build.yml
    secrets: inherit

  docker-all-in-one:
    needs: [unit-tests]
    uses: ./.github/workflows/ci-docker-all-in-one.yml
    secrets: inherit
    permissions:
      contents: read
      packages: read

  docker-hotrod:
    needs: [unit-tests]
    uses: ./.github/workflows/ci-docker-hotrod.yml
    secrets: inherit

  # E2E tests
  e2e-tests:
    needs: [unit-tests]
    uses: ./.github/workflows/ci-e2e-all.yml
    secrets: inherit

  e2e-spm:
    needs: [unit-tests]
    uses: ./.github/workflows/ci-e2e-spm.yml
    secrets: inherit

  e2e-tailsampling:
    needs: [unit-tests]
    uses: ./.github/workflows/ci-e2e-tailsampling.yml
    secrets: inherit

  # ============================================================================
  # FINAL GATEKEEPER: Use this job for Branch Protection
  # ============================================================================
  ci-success:
    name: All CI Checks Passed
    runs-on: ubuntu-latest
    if: always()
    needs:
      # Tier 3 dependencies - all expensive checks must pass
      - build-binaries
      - docker-build
      - docker-all-in-one
      - docker-hotrod
      - e2e-tests
      - e2e-spm
      - e2e-tailsampling
    steps:
      - name: Harden Runner
        uses: step-security/harden-runner@20cf305ff2072d973412fa9b1e3a4f227bda3c76 # v2.14.0
        with:
          egress-policy: audit

      - name: Check Overall Status
        run: |
          # Check if all jobs succeeded or were skipped
          results=(
            "${{ needs.build-binaries.result }}"
            "${{ needs.docker-build.result }}"
            "${{ needs.docker-all-in-one.result }}"
            "${{ needs.docker-hotrod.result }}"
            "${{ needs.e2e-tests.result }}"
            "${{ needs.e2e-spm.result }}"
            "${{ needs.e2e-tailsampling.result }}"
          )
          
          failed=0
          for result in "${results[@]}"; do
            if [[ "$result" != "success" && "$result" != "skipped" ]]; then
              echo "❌ Job failed or was cancelled: $result"
              failed=1
            fi
          done
          
          if [ $failed -eq 0 ]; then
            echo "✅ All CI tiers passed successfully!"
            exit 0
          else
            echo "❌ CI failed in one or more tiers"
            exit 1
          fi
