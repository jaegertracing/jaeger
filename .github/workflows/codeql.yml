name: "CodeQL"

on:
  merge_group:
  push:
    branches: [main]

  pull_request:
    branches: [main]

  schedule:
    - cron: '31 6 * * 1'

concurrency:
  group: ${{ github.workflow }}-${{ (github.event.pull_request && github.event.pull_request.number) || github.ref || github.run_id }}
  cancel-in-progress: true

# See https://github.com/ossf/scorecard/blob/main/docs/checks.md#token-permissions
permissions:  # added using https://github.com/step-security/secure-workflows
  contents: read

jobs:
  codeql-analyze:
    # Skip merge_group to avoid duplicate runs (code already scanned on pull_request)
    # See https://github.com/github/codeql-action/issues/1537
    if: ${{ github.event_name != 'merge_group' }}
    name: CodeQL Analyze
    runs-on: ubuntu-latest

    permissions:
      security-events: write
      actions: read

    strategy:
      fail-fast: false
      matrix:
        language: [ 'go', 'python' ]

    steps:
    - name: Harden Runner
      uses: step-security/harden-runner@ec9f2d5744a09debf3a187a3f4f675c53b671911 # v2.13.0
      with:
        egress-policy: audit

    - name: Checkout repository
      uses: actions/checkout@1af3b93b6815bc44a9784bd300feb67ff0d1eeb3 # v6.0.0
      with:
        submodules: true  # Jaeger uses submodules (jaeger-ui, idl)

    - name: Setup Go
      if: matrix.language == 'go'
      uses: actions/setup-go@v5
      with:
        go-version: stable

    - name: Initialize CodeQL
      uses: github/codeql-action/init@f443b600d91635bebf5b0d9ebc620189c0d6fba5 # v4
      with:
        languages: ${{ matrix.language }}

    # Use Autobuild for Python (it works fine for interpreted languages)
    - name: Autobuild (Python)
      if: matrix.language == 'python'
      uses: github/codeql-action/autobuild@f443b600d91635bebf5b0d9ebc620189c0d6fba5 # v4

    # Explicit build for Go - required for CodeQL to analyze compiled code
    - name: Build Go code
      if: matrix.language == 'go'
      run: |
        # Build all Go binaries to ensure CodeQL can analyze them
        go build -v ./...

    - name: Perform CodeQL Analysis
      uses: github/codeql-action/analyze@f443b600d91635bebf5b0d9ebc620189c0d6fba5 # v4
