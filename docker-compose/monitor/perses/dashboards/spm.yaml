{
  "kind": "Dashboard",
  "metadata": {
    "name": "spm",
    "createdAt": "2024-11-13T18:40:17.312950785Z",
    "updatedAt": "2024-11-13T18:48:54.863814983Z",
    "version": 2,
    "project": "jaeger"
  },
  "spec": {
    "display": {
      "name": "SPM Dashboard"
    },
    "datasources": {
      "NewDatasource": {
        "default": true,
        "plugin": {
          "kind": "PrometheusDatasource",
          "spec": {
            "proxy": {
              "kind": "HTTPProxy",
              "spec": {
                "allowedEndpoints": [
                  {
                    "endpointPattern": "/api/v1/labels",
                    "method": "POST"
                  },
                  {
                    "endpointPattern": "/api/v1/series",
                    "method": "POST"
                  },
                  {
                    "endpointPattern": "/api/v1/metadata",
                    "method": "GET"
                  },
                  {
                    "endpointPattern": "/api/v1/query",
                    "method": "POST"
                  },
                  {
                    "endpointPattern": "/api/v1/query_range",
                    "method": "POST"
                  },
                  {
                    "endpointPattern": "/api/v1/label/([a-zA-Z0-9_-]+)/values",
                    "method": "GET"
                  },
                  {
                    "endpointPattern": "/api/v1/parse_query",
                    "method": "POST"
                  }
                ],
                "url": "http://prometheus:9090"
              }
            }
          }
        }
      }
    },
    "variables": [
      {
        "kind": "ListVariable",
        "spec": {
          "display": {
            "name": "Service",
            "hidden": false
          },
          "defaultValue": [
            "frontend"
          ],
          "allowAllValue": true,
          "allowMultiple": true,
          "sort": "none",
          "plugin": {
            "kind": "PrometheusLabelValuesVariable",
            "spec": {
              "labelName": "service_name",
              "matchers": [
                "traces_span_metrics_calls_total"
              ]
            }
          },
          "name": "service"
        }
      }
    ],
    "panels": {
      "0_0": {
        "kind": "Panel",
        "spec": {
          "display": {
            "name": "Total # of spans"
          },
          "plugin": {
            "kind": "StatChart",
            "spec": {
              "calculation": "sum",
              "thresholds": {
                "steps": [
                  {
                    "color": "semi-dark-blue",
                    "value": 0
                  }
                ]
              }
            }
          },
          "queries": [
            {
              "kind": "TimeSeriesQuery",
              "spec": {
                "plugin": {
                  "kind": "PrometheusTimeSeriesQuery",
                  "spec": {
                    "minStep": "",
                    "query": "sum (rate(traces_span_metrics_calls_total{service_name=~\"$service\"}[$__rate_interval]))",
                    "seriesNameFormat": "{{service_name}}"
                  }
                }
              }
            }
          ]
        }
      },
      "0_1": {
        "kind": "Panel",
        "spec": {
          "display": {
            "name": "Spans per service"
          },
          "plugin": {
            "kind": "TimeSeriesChart",
            "spec": {
              "visual": {}
            }
          },
          "queries": [
            {
              "kind": "TimeSeriesQuery",
              "spec": {
                "plugin": {
                  "kind": "PrometheusTimeSeriesQuery",
                  "spec": {
                    "minStep": "",
                    "query": "sum by (service_name) (rate(traces_span_metrics_calls_total{service_name=~\"$service\"}[$__rate_interval]))",
                    "seriesNameFormat": "{{service_name}}"
                  }
                }
              }
            }
          ]
        }
      },
      "0_2": {
        "kind": "Panel",
        "spec": {
          "display": {
            "name": "Avg Error Rate"
          },
          "plugin": {
            "kind": "StatChart",
            "spec": {
              "calculation": "mean",
              "format": {
                "unit": "percent-decimal"
              },
              "thresholds": {
                "steps": [
                  {
                    "color": "green",
                    "value": 0
                  },
                  {
                    "color": "red",
                    "value": 0.2
                  }
                ]
              }
            }
          },
          "queries": [
            {
              "kind": "TimeSeriesQuery",
              "spec": {
                "plugin": {
                  "kind": "PrometheusTimeSeriesQuery",
                  "spec": {
                    "minStep": "",
                    "query": "sum (rate(traces_span_metrics_calls_total{service_name=~\"$service\",status_code=~\"STATUS_CODE_ERROR\"}[$__rate_interval])) / sum (rate(traces_span_metrics_calls_total{service_name=~\"$service\"}[$__rate_interval]))",
                    "seriesNameFormat": ""
                  }
                }
              }
            }
          ]
        }
      },
      "0_3": {
        "kind": "Panel",
        "spec": {
          "display": {
            "name": "Error Rate per Service"
          },
          "plugin": {
            "kind": "TimeSeriesChart",
            "spec": {
              "visual": {},
              "yAxis": {
                "format": {
                  "unit": "percent-decimal"
                }
              }
            }
          },
          "queries": [
            {
              "kind": "TimeSeriesQuery",
              "spec": {
                "plugin": {
                  "kind": "PrometheusTimeSeriesQuery",
                  "spec": {
                    "minStep": "",
                    "query": "sum by (service_name) (rate(traces_span_metrics_calls_total{service_name=~\"$service\",status_code=~\"STATUS_CODE_ERROR\"}[$__rate_interval])) / sum by (service_name) (rate(traces_span_metrics_calls_total{service_name=~\"$service\"}[$__rate_interval]))",
                    "seriesNameFormat": "{{service_name}}"
                  }
                }
              }
            }
          ]
        }
      },
      "0_4": {
        "kind": "Panel",
        "spec": {
          "display": {
            "name": "Latency per Service"
          },
          "plugin": {
            "kind": "TimeSeriesChart",
            "spec": {
              "visual": {},
              "yAxis": {
                "format": {
                  "unit": "milliseconds"
                }
              }
            }
          },
          "queries": [
            {
              "kind": "TimeSeriesQuery",
              "spec": {
                "plugin": {
                  "kind": "PrometheusTimeSeriesQuery",
                  "spec": {
                    "minStep": "",
                    "query": "histogram_quantile(0.95, sum(rate(traces_span_metrics_duration_milliseconds_bucket{service_name=~\"$service\"}[$__rate_interval])) by (service_name,le))",
                    "seriesNameFormat": "{{service_name}}"
                  }
                }
              }
            }
          ]
        }
      },
      "0_5": {
        "kind": "Panel",
        "spec": {
          "display": {
            "name": "Stats"
          },
          "plugin": {
            "kind": "Table",
            "spec": {
              "columnSettings": []
            }
          },
          "queries": [
            {
              "kind": "TimeSeriesQuery",
              "spec": {
                "plugin": {
                  "kind": "PrometheusTimeSeriesQuery",
                  "spec": {
                    "minStep": "",
                    "query": "sum by (service_name)(rate(calls_total[$__rate_interval]))",
                    "seriesNameFormat": ""
                  }
                }
              }
            },
            {
              "kind": "TimeSeriesQuery",
              "spec": {
                "plugin": {
                  "kind": "PrometheusTimeSeriesQuery",
                  "spec": {
                    "minStep": "",
                    "query": "histogram_quantile(0.95, sum(rate(latency_bucket[5m])) by (service_name,le))",
                    "seriesNameFormat": ""
                  }
                }
              }
            },
            {
              "kind": "TimeSeriesQuery",
              "spec": {
                "plugin": {
                  "kind": "PrometheusTimeSeriesQuery",
                  "spec": {
                    "minStep": "",
                    "query": "sum by (service_name)(rate(calls_total{status_code=\"STATUS_CODE_ERROR\"}[$__rate_interval]))/sum by (service_name)(rate(calls_total[$__rate_interval]))",
                    "seriesNameFormat": ""
                  }
                }
              }
            }
          ]
        }
      },
      "1_0": {
        "kind": "Panel",
        "spec": {
          "display": {
            "name": "Total # of spans"
          },
          "plugin": {
            "kind": "StatChart",
            "spec": {
              "calculation": "sum",
              "thresholds": {
                "steps": []
              }
            }
          },
          "queries": [
            {
              "kind": "TimeSeriesQuery",
              "spec": {
                "plugin": {
                  "kind": "PrometheusTimeSeriesQuery",
                  "spec": {
                    "minStep": "",
                    "query": "sum (rate(calls_total{service_name=~\"$service\"}[$__rate_interval]))",
                    "seriesNameFormat": "{{service_name}}"
                  }
                }
              }
            }
          ]
        }
      },
      "1_1": {
        "kind": "Panel",
        "spec": {
          "display": {
            "name": "Latency per Operation"
          },
          "plugin": {
            "kind": "TimeSeriesChart",
            "spec": {
              "visual": {},
              "yAxis": {
                "format": {
                  "unit": "milliseconds"
                }
              }
            }
          },
          "queries": [
            {
              "kind": "TimeSeriesQuery",
              "spec": {
                "plugin": {
                  "kind": "PrometheusTimeSeriesQuery",
                  "spec": {
                    "minStep": "",
                    "query": "histogram_quantile(0.95, sum(rate(latency_bucket{service_name=~\"$service\"}[$__rate_interval])) by (operation,le))",
                    "seriesNameFormat": "{{operation}}"
                  }
                }
              }
            }
          ]
        }
      },
      "1_2": {
        "kind": "Panel",
        "spec": {
          "display": {
            "name": "Spans per service"
          },
          "plugin": {
            "kind": "TimeSeriesChart",
            "spec": {
              "visual": {}
            }
          },
          "queries": [
            {
              "kind": "TimeSeriesQuery",
              "spec": {
                "plugin": {
                  "kind": "PrometheusTimeSeriesQuery",
                  "spec": {
                    "minStep": "",
                    "query": "sum by (operation) (rate(calls_total{service_name=~\"$service\"}[$__rate_interval]))",
                    "seriesNameFormat": "{{operation}}"
                  }
                }
              }
            }
          ]
        }
      },
      "1_3": {
        "kind": "Panel",
        "spec": {
          "display": {
            "name": "Error Rate per Operation"
          },
          "plugin": {
            "kind": "TimeSeriesChart",
            "spec": {
              "visual": {},
              "yAxis": {
                "format": {
                  "unit": "percent-decimal"
                }
              }
            }
          },
          "queries": [
            {
              "kind": "TimeSeriesQuery",
              "spec": {
                "plugin": {
                  "kind": "PrometheusTimeSeriesQuery",
                  "spec": {
                    "minStep": "",
                    "query": "sum by (operation) (rate(calls_total{service_name=~\"$service\",status_code=~\"STATUS_CODE_ERROR\"}[$__rate_interval])) / sum by (operation) (rate(calls_total{service_name=~\"$service\"}[$__rate_interval]))",
                    "seriesNameFormat": "{{operation}}"
                  }
                }
              }
            }
          ]
        }
      },
      "1_4": {
        "kind": "Panel",
        "spec": {
          "display": {
            "name": "Avg Error Rate"
          },
          "plugin": {
            "kind": "StatChart",
            "spec": {
              "calculation": "mean",
              "format": {
                "unit": "percent-decimal"
              },
              "thresholds": {
                "steps": [
                  {
                    "color": "red",
                    "value": 0.2
                  }
                ]
              }
            }
          },
          "queries": [
            {
              "kind": "TimeSeriesQuery",
              "spec": {
                "plugin": {
                  "kind": "PrometheusTimeSeriesQuery",
                  "spec": {
                    "minStep": "",
                    "query": "sum (rate(calls_total{service_name=~\"$service\",status_code=~\"STATUS_CODE_ERROR\"}[$__rate_interval])) / sum (rate(calls_total{service_name=~\"$service\"}[$__rate_interval]))",
                    "seriesNameFormat": ""
                  }
                }
              }
            }
          ]
        }
      }
    },
    "layouts": [
      {
        "kind": "Grid",
        "spec": {
          "display": {
            "title": "General information",
            "collapse": {
              "open": true
            }
          },
          "items": [
            {
              "x": 0,
              "y": 0,
              "width": 3,
              "height": 4,
              "content": {
                "$ref": "#/spec/panels/0_0"
              }
            },
            {
              "x": 3,
              "y": 0,
              "width": 21,
              "height": 8,
              "content": {
                "$ref": "#/spec/panels/0_1"
              }
            },
            {
              "x": 0,
              "y": 4,
              "width": 3,
              "height": 4,
              "content": {
                "$ref": "#/spec/panels/0_2"
              }
            },
            {
              "x": 0,
              "y": 8,
              "width": 12,
              "height": 8,
              "content": {
                "$ref": "#/spec/panels/0_3"
              }
            },
            {
              "x": 12,
              "y": 8,
              "width": 12,
              "height": 8,
              "content": {
                "$ref": "#/spec/panels/0_4"
              }
            },
            {
              "x": 0,
              "y": 16,
              "width": 24,
              "height": 7,
              "content": {
                "$ref": "#/spec/panels/0_5"
              }
            }
          ]
        }
      },
      {
        "kind": "Grid",
        "spec": {
          "display": {
            "title": "$service - Stats per Service",
            "collapse": {
              "open": true
            }
          },
          "items": [
            {
              "x": 0,
              "y": 0,
              "width": 2,
              "height": 3,
              "content": {
                "$ref": "#/spec/panels/1_0"
              }
            },
            {
              "x": 2,
              "y": 0,
              "width": 8,
              "height": 6,
              "content": {
                "$ref": "#/spec/panels/1_1"
              }
            },
            {
              "x": 10,
              "y": 0,
              "width": 8,
              "height": 6,
              "content": {
                "$ref": "#/spec/panels/1_2"
              }
            },
            {
              "x": 18,
              "y": 0,
              "width": 6,
              "height": 6,
              "content": {
                "$ref": "#/spec/panels/1_3"
              }
            },
            {
              "x": 0,
              "y": 3,
              "width": 2,
              "height": 3,
              "content": {
                "$ref": "#/spec/panels/1_4"
              }
            }
          ]
        }
      }
    ],
    "duration": "5m"
  }
}
