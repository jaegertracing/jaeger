services:
  hotrod:
    image: cr.jaegertracing.io/jaegertracing/example-hotrod:latest
    ports:
      - '8080:8080'
      - '8083:8083'
    command: ["all"]
    environment:
      - OTEL_EXPORTER_OTLP_ENDPOINT=http://jaeger:4318
    depends_on:
      cassandra-schema:
        condition: service_completed_successfully
      jaeger:
        condition: service_started
    networks:
      - jaeger-network

  jaeger:
    image: cr.jaegertracing.io/jaegertracing/jaeger:latest
    volumes:
      - ../cmd/jaeger/config-cassandra.yaml:/etc/jaeger/config.yaml:ro
    command: ["--config", "/etc/jaeger/config.yaml"]
    environment:
      - CASSANDRA_CONTACT_POINTS=cassandra:9042
    ports:
      - "16686:16686"  # Jaeger UI
      - "4317:4317"    # OTLP gRPC
      - "4318:4318"    # OTLP HTTP
      - "14250:14250"  # Jaeger gRPC
      - "14268:14268"  # Jaeger HTTP
      - "5778:5778"    # Sampling endpoint
    restart: on-failure
    depends_on:
      cassandra-schema:
        condition: service_completed_successfully
    networks:
      - jaeger-network

  cassandra:
    image: cassandra:4.0
    networks:
      - jaeger-network
    healthcheck:
      test: ["CMD", "cqlsh", "-e", "describe keyspaces"]
      interval: 10s
      timeout: 5s
      retries: 10

  cassandra-schema:
    image: cr.jaegertracing.io/jaegertracing/jaeger-cassandra-schema:latest
    depends_on:
      cassandra:
        condition: service_healthy
    networks:
      - jaeger-network

networks:
  jaeger-network:
    driver: bridge
