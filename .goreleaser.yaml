# Copyright (c) 2024 The Jaeger Authors.
# SPDX-License-Identifier: Apache-2.0

# This file is used by goreleaser to automate the release process.
# See https://goreleaser.com for more information.

version: 2

project_name: jaeger

# Build configuration
builds:
  # Jaeger v2 binary
  - id: jaeger
    main: ./cmd/jaeger
    binary: jaeger
    env:
      - CGO_ENABLED=0
    goos: &common_goos
      - linux
      - darwin
      - windows
    goarch: &common_goarch
      - amd64
      - arm64
      - s390x
      - ppc64le
    ignore: &common_ignore
      - goos: darwin
        goarch: s390x
      - goos: darwin
        goarch: ppc64le
      - goos: windows
        goarch: s390x
      - goos: windows
        goarch: ppc64le
      - goos: windows
        goarch: arm64
    ldflags: &ldflags_version
      - -X github.com/jaegertracing/jaeger/internal/version.commitSHA={{.FullCommit}}
      - -X github.com/jaegertracing/jaeger/internal/version.latestVersion={{.Env.VERSION}}
      - -X github.com/jaegertracing/jaeger/internal/version.date={{.Date}}

  # Tool binaries
  - id: es-index-cleaner
    main: ./cmd/es-index-cleaner
    binary: jaeger-es-index-cleaner
    env:
      - CGO_ENABLED=0
    goos: *common_goos
    goarch: *common_goarch
    ignore: *common_ignore
    ldflags: *ldflags_version

  - id: es-rollover
    main: ./cmd/es-rollover
    binary: jaeger-es-rollover
    env:
      - CGO_ENABLED=0
    goos: *common_goos
    goarch: *common_goarch
    ignore: *common_ignore
    ldflags: *ldflags_version

  - id: esmapping-generator
    main: ./cmd/esmapping-generator
    binary: jaeger-esmapping-generator
    env:
      - CGO_ENABLED=0
    goos: *common_goos
    goarch: *common_goarch
    ignore: *common_ignore
    ldflags: *ldflags_version

  # Example application
  - id: hotrod
    main: ./examples/hotrod/main.go
    binary: example-hotrod
    env:
      - CGO_ENABLED=0
    goos: *common_goos
    goarch: *common_goarch
    ignore: *common_ignore
    ldflags: *ldflags_version

# Archive configuration
# Note: The 'builds' field is deprecated in GoReleaser v2.
# TODO: Migrate to using build filters when goreleaser v2 stabilizes the new approach.
# For now, 'builds' is still functional and simplifies creating separate archives.
archives:
  # Main Jaeger archive - includes jaeger binary and hotrod
  - id: jaeger
    formats: [tar.gz]
    name_template: "jaeger-{{ .Env.VERSION_CLEAN }}-{{ .Os }}-{{ .Arch }}"
    format_overrides:
      - goos: windows
        formats: [zip]
    files:
      - none*  # Don't include extra files
    builds:
      - jaeger
      - hotrod

  # Tools archive - includes ES tools
  - id: jaeger-tools
    formats: [tar.gz]
    name_template: "jaeger-tools-{{ .Env.VERSION_CLEAN }}-{{ .Os }}-{{ .Arch }}"
    format_overrides:
      - goos: windows
        formats: [zip]
    files:
      - none*  # Don't include extra files
    builds:
      - es-index-cleaner
      - es-rollover
      - esmapping-generator

# Checksum configuration
checksum:
  name_template: "checksums.txt"
  algorithm: sha256

# GPG signing configuration
signs:
  - signature: "${artifact}.asc"
    cmd: gpg
    args:
      - --armor
      - --detach-sign
      - "${artifact}"
    artifacts: all

# Release configuration
release:
  github:
    owner: jaegertracing
    name: jaeger
  draft: false
  prerelease: auto
  mode: replace  # Replace artifacts if they exist
  make_latest: true
